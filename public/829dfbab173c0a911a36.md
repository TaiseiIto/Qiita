---
title: MikanOSのビルドを自動化してみた
tags:
  - 自作OS
  - mikanos
private: false
updated_at: '2025-12-18T09:10:15+09:00'
id: 829dfbab173c0a911a36
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに

こんにちは．[だいみょーじん](https://x.com/Egh2Deywos)です．
この記事は，[第43回自作OSもくもく会](https://osdev-jp.connpass.com/event/338967/)で発表した内容をまとめ，[自作OSアドベントカレンダー2025](https://adventar.org/calendars/11966)の18日目の記事として公開したものです．
対象読者は，[ゼロからのOS自作入門](https://book.mynavi.jp/ec/products/detail/id=121220)を読んだことがある人です．

# MikanOSとは

[uchan_nos](https://x.com/uchan_nos)さんの著作，[ゼロからのOS自作入門](https://book.mynavi.jp/ec/products/detail/id=121220)は，OS自作初心者を対象にOSを開発する過程をゼロから解説し，コードを書き写すことで段階的にOS開発を体験できる書籍です．
この書籍で開発される教育用OSが[MikanOS](https://github.com/uchan-nos/mikanos)です．
OS自作初心者は「ゼロからのOS自作入門」を読み，MikanOSを段階的に開発していくことで，OS自作を体験できるわけです．
私もこの書籍を読んでMikanOSを開発しましたが，環境構築やビルド手順が少々面倒だったので，自動化してみました！
自動化スクリプトは[こちら](https://github.com/TaiseiIto/mikanos)からご覧ください．

# MikanOSのビルド手順

「ゼロからのOS自作入門」で説明されているMikanOSの大まかなビルド手順は以下のとおりです．

1. mikanos-buildをosbookとしてクローン
1. ansibleで必要なツールをインストール
1. mikanosをクローン
1. EDKⅡのディレクトリにMikanOSブートローダのディレクトリをリンク
1. `edksetup.sh`を読み込むことでEDKⅡのビルドに必要な環境変数を設定
1. 自動生成された`Conf/target.txt`を編集
1. ブートローダをビルド
1. `osbook/devenv/buildenv.sh`を読み込むことでMikanOSのビルドに必要な環境変数を設定
1. MikanOSをビルド
1. MikanOSのイメージファイル`disk.img`が完成

この一連の手順を自動化しましょう．

# ブートローダのビルド

[MikanOSのビルド手順](#mikanosのビルド手順)のうち，ブートローダのビルドに関わるのはこの部分です．

1. `edksetup.sh`を読み込むことでEDKⅡのビルドに必要な環境変数を設定
1. 自動生成された`Conf/target.txt`を編集
1. ブートローダをビルド

この部分を[`build_boot_loader.sh`](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/build_boot_loader.sh)で自動化しましょう．

```bash:build_boot_loader.sh
#!/bin/bash

source edksetup.sh
cd Conf
sed -i "s/^ACTIVE_PLATFORM[\t ]*=[\t ]*.*$/ACTIVE_PLATFORM = MikanLoaderPkg\/MikanLoaderPkg.dsc/" target.txt
sed -i "s/^TARGET[\t ]*=[\t ]*.*$/TARGET = DEBUG/" target.txt
sed -i "s/^TARGET_ARCH[\t ]*=[\t ]*.*$/TARGET_ARCH = X64/" target.txt
sed -i "s/^TOOL_CHAIN_TAG[\t ]*=[\t ]*.*$/TOOL_CHAIN_TAG = CLANG38/" target.txt
build
```

`sed`コマンドでブートローダをビルドする際の設定ファイルである`target.txt`のACTIVE_PLATFORM，TARGET，TARGET_ARCH，TOOL_CHAIN_TAGの各設定項目を記入します．
そして最後に`build`コマンドでブートローダをビルドします．

# MikanOS本体のビルド

[MikanOSのビルド手順](#mikanosのビルド手順)のうち，MikanOS本体のビルドに関わるのはこの部分です．

1. `osbook/devenv/buildenv.sh`を読み込むことでMikanOSのビルドに必要な環境変数を設定
1. MikanOSをビルド
1. MikanOSのイメージファイル`disk.img`が完成

この部分を[`build_mikanos.sh`](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/build_mikanos.sh)で自動化しましょう．

```bash:build_mikanos.sh
#!/bin/bash

source /root/osbook/devenv/buildenv.sh
./build.sh
```

[`osbook/devenv/buildenv.sh`](https://github.com/uchan-nos/mikanos-build/blob/8d4882122ec548ef680b6b5a2ae841a0fd4d07a1/devenv/buildenv.sh)でビルドに必要な環境変数を設定し，[`build.sh`](https://github.com/uchan-nos/mikanos/blob/b5f7740c04002e67a95af16a5c6e073b664bf3f5/build.sh)でMikanOSをビルドします．
最後に[`Makefile`](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/Makefile)を記述し，`make`コマンド一発でMikanOSのイメージファイルと，それをマウントしたディレクトリを生成できるようにします．

```Makefile:Makefile
REPOSITORY=$(shell git config --get remote.origin.url)
PRODUCT=$(shell echo $(REPOSITORY) | awk -F '[./]' '{print $$(NF-1)}')
IMAGE=$(shell echo $(PRODUCT) | awk '{print tolower($$0)}')
CONTAINER=$(IMAGE)
VNC_PORT=5900
MOUNT=disk
TARGET=$(MOUNT).img

$(MOUNT): $(TARGET)
	if mountpoint -q $@; then sudo umount -l $@; fi
	if [ -e $@ ] ; then rm -rf $@; fi
	mkdir $@
	sudo mount -o loop $^ $@

$(TARGET):
	./build.sh $(IMAGE) $(CONTAINER) $(VNC_PORT) $(TARGET)
```

これでビルド自体は自動化できたわけですが，ビルド以前の環境構築の部分も自動化したくなってきます．

# 環境構築の自動化

[MikanOSのビルド手順](#mikanosのビルド手順)のうち，環境構築に関わるのはこの部分です．

1. mikanos-buildをosbookとしてクローン
1. ansibleで必要なツールをインストール
1. mikanosをクローン

これを自動化するためのDockerを使いましょう．
全体的な流れはこんな感じです．

![build.drawio.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2354177/da479b9d-55e4-4de6-9ac4-0751bb3c988b.png)

1. `Dockerfile`に従ってMikanOSをビルドするための環境を構築
1. Dockerコンテナ上で`build_boot_loader.sh`を実行してブートローダをビルド
1. Dockerコンテナ上で`build_mikanos.sh`を実行してMikanOS本体をビルド
1. DockerコンテナからビルドされたMikanOSのイメージファイル`disk.img`を取得

この手順を[`build.sh`](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/build.sh)に記述します．

```bash:build.sh
#!/bin/bash

image=$1
container=$2
vnc_port=$3
target=$4

# Build a docker image.
if [ -z "$(docker images --format {{.Repository}} $image)" ]; then
	docker build --build-arg vnc_port=$vnc_port -t $image . # ビルド環境を構築
fi

# Create a docker conatiner.
if [ -z "$(docker ps -a --format {{.Names}} --filter name=^$container\$)" ]; then
	docker create -i -t -p $vnc_port:$vnc_port --privileged --name $container $image /bin/bash
	docker start $container
	docker exec --workdir /root/edk2 $container ./build_boot_loader.sh # ブートローダをビルド
	docker exec --workdir /root/mikanos $container ./build_mikanos.sh # MikanOS本体をビルド
	docker stop $container
fi

# Download MikanOS image file.
docker cp $container:/root/mikanos/$4 $4 # ビルドされたMikanOSイメージファイルを取得
```

次に，環境構築の手順を[`Dockerfile`](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/Dockerfile)に記述します．

```Dockerfile:Dockerfile
FROM ubuntu:20.04

# Don't ask stdin anything to install software automatically.
ENV DEBIAN_FRONTEND=noninteractive

# Install softwares.
RUN apt-get update && apt-get upgrade -y && apt-get install -y ansible # MikanOSのビルドに必要なものを一括インストールする用
RUN apt-get update && apt-get upgrade -y && apt-get install -y dosfstools # FAT32イメージファイル作成用
RUN apt-get update && apt-get upgrade -y && apt-get install -y git
RUN apt-get update && apt-get upgrade -y && apt-get install -y vim

# Build MikanOS.
WORKDIR /root
COPY osbook.patch /root/osbook.patch
RUN git clone https://github.com/uchan-nos/mikanos-build.git osbook # MikanOSビルドツールをクローン
WORKDIR /root/osbook
RUN git checkout 8d4882122ec548ef680b6b5a2ae841a0fd4d07a1 # 将来の変更によるミスマッチを防ぐため固定コミットにチェックアウト
RUN git apply ../osbook.patch # Dockerのrootアカウントではsudoが必要なくなるので，sudoを消すパッチを当てる
WORKDIR /root/osbook/devenv
RUN ansible-playbook -i ansible_inventory ansible_provision.yml # MikanOSのビルドに必要なものを一括インストール
WORKDIR /root
RUN git clone https://github.com/uchan-nos/mikanos.git # MikanOS本体をクローン
WORKDIR /root/mikanos
RUN git checkout b5f7740c04002e67a95af16a5c6e073b664bf3f5 # 将来の変更によるミスマッチを防ぐため固定コミットにチェックアウト
WORKDIR /root/edk2
RUN ln -s /root/mikanos/MikanLoaderPkg . # EDKⅡのディレクトリにMikanOSのブートローダのディレクトリをリンク
# ブートローダをビルドするシェルスクリプトを配置
COPY build_boot_loader.sh /root/edk2/build_boot_loader.sh
# MikanOS本体をビルドするシェルスクリプトを配置
COPY build_mikanos.sh /root/mikanos/build_mikanos.sh
WORKDIR /root

# Set
ENV APPS_DIR apps
ENV RESOURCE_DIR resource

# Expose VNC port.
ARG vnc_port
EXPOSE $vnc_port
```

これでビルド環境の構築からMikanOSのビルドまでを自動化できました．

# Docker上でMikanOSを実行

MikanOSのビルドを自動化できたので，今度はQEMUにおけるMikanOSの実行も自動化したくなります．
こんな風に，Docker上でQEMUを動かし，ホスト上のVNC viewerを介して人間とやり取りすれば良さそうです．

![run.drawio.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2354177/ba8c8961-caa9-495e-b457-d742b6154c23.png)

既に[`osbook/devenv/run_image.sh`](https://github.com/uchan-nos/mikanos-build/blob/8d4882122ec548ef680b6b5a2ae841a0fd4d07a1/devenv/run_image.sh)にQEMUでMikanOSを走らせるコマンドが書かれていますが，このコマンドはVNC接続していないので，VNC接続するように`-vnc :0`というオプションを追記する[パッチ](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/osbook.patch#L69)を当てます．
こうするとQEMUは5900番ポートでVNC接続を待機するようになります．
さらに，上に記載したDockerfileのEXPOSEコマンドにより，Dockerコンテナの5900番ポートに穴を開ければ，Dockerコンテナ上で動くQEMUとホスト上で動くVNC viewerが通信できるようになります．
最後に，[`Makefile`](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/Makefile)にDockerコンテナ上のQEMUでMikanOSを動かすコマンドを書いておきます．

```Makefile:Makefile
.PHONY: run
run: build
	docker stop $(CONTAINER)
	docker start $(CONTAINER)
	docker exec --workdir /root/mikanos $(CONTAINER) ./build.sh run
```

`make run`してQEMUで立ち上がったのを確認し，VNC viewerで`localhost:5900`にアクセスするとMikanOSを操作できます．

![mikanos.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2354177/e9b0bfce-de58-4648-b096-a6e9f9a2128c.png)

ここまでで，ワンコマンドでMikanOSをビルドしたり，動かしたりできるようになりました．

# GitHub Actionsによるビルド

次はゼロコマンドでビルド済みのMikanOSのイメージを取得できるようにしましょう．
[`.github/workflows/build.yml`](https://github.com/TaiseiIto/mikanos/blob/885a5887c94250e9483a8f13f45b8ba99f3217c8/.github/workflows/build.yml)で`make build`を実行してビルド済みMikanOSイメージをマウントした`disk`ディレクトリを作成し，それを生成物としてアップロードします．

```yml:build.yml
name: build
on:
  push:
    branches:
      - main
      - issue1
jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@main
      - name: Build MikanOS
        run: make build
      - name: Upload MikanOS
        uses: actions/upload-artifact@main
        with:
          name: MikanOS
          path: disk
```

これで[こちら](https://github.com/TaiseiIto/mikanos/actions/runs/16712948129)からビルド済みのMikanOSをダウンロードできるようになりました．
実質ゼロコマンドでMikanOSを入手できます！

![artifact.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2354177/82de5bf2-93f7-474d-a8f2-6dac1fd58de3.png)

# まとめ

* MikanOSのビルドを自動化
* Dockerを使うことで，1コマンドで環境構築からビルドまでできるように
* VNC通信によりDocker上のQEMUで動くMikanOSを操作
* GitHub Actionsを使うことで，GitHubからビルド済みのMikanOSをダウンロードできるように

# 参考文献

* [ゼロからのOS自作入門](https://book.mynavi.jp/ec/products/detail/id=121220)
